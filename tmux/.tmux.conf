# --------------------------------
# Set Default shell to zsh
# --------------------------------
set-option -g default-shell /usr/bin/zsh
set-option -g default-command /usr/bin/zsh

# ------------------------------
# General
# ------------------------------

unbind C-b
set-option -g prefix C-a
set -g base-index 1 
set -g escape-time 0 
set -g detach-on-destroy off 
setw -g mode-keys vi # Use vi style keys in copy mode
set -g mouse off
set -g renumber-windows on
set -g history-limit 10000
set -s default-terminal 'tmux-256color'
set -g set-clipboard on # Use system clipboard when possible
setw -g automatic-rename on

# OSC52 copy to local clipboard (works over SSH)
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel \
"tmux save-buffer - | base64 | tr -d '\n' | sed 's/.*/\x1b]52;c;&\x07/'"

# Prefix + / to search
bind-key / copy-mode \; send-key ?


# Reload config 
bind r source-file ~/.tmux.conf \; display "tmux reloaded"

##### Safe Ctrl-D (donâ€™t kill last tmux session) #####
bind -n C-d if-shell -F "#{&&:#{==:#{session_windows},1},#{==:#{window_panes},1}}" \
  "detach-client" \
  "send-keys C-d"

# ------------------------------
# Splits (vim-style)
# ------------------------------

bind v split-window -h -c "#{pane_current_path}"
bind s split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# ------------------------------
# Pane navigation (vim keys)
# ------------------------------
# Neovim <-> tmux navigation
# ------------------------------
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(n?vim)$'"

bind -n C-h if-shell "$is_vim" "send-keys C-h" "select-pane -L"
bind -n C-j if-shell "$is_vim" "send-keys C-j" "select-pane -D"
bind -n C-k if-shell "$is_vim" "send-keys C-k" "select-pane -U"
bind -n C-l if-shell "$is_vim" "send-keys C-l" "select-pane -R"

# Resize panes
bind < resize-pane -L 10
bind + resize-pane -D 10
bind - resize-pane -U 10
bind > resize-pane -R 10

# ------------------------------
# Windows
# ------------------------------
bind A choose-session
bind m choose-tree
bind c new-window -c "#{pane_current_path}"
bind n next-window
bind p previous-window

# Swap Windows
bind-key -n C-S-Left swap-window -d -t -1
bind-key -n C-S-Right swap-window -d -t +1

# Session Management
 unbind S
 bind S command-prompt 'rename-session %%'
 bind N new-session
# # Create new session from current window
 bind B command-prompt -p "New session name:" "new-session -d -s '%%'; move-window -t '%%:'; switch-client -t '%%'"

# -----------------------------
# Popups
# -----------------------------

bind C-g display-popup \
  -d "#{pane_current_path}" \
  -w 80% \
  -h 80% \
  -E "lazygit"
bind C-f display-popup \
  -d "#{pane_current_path}" \
  -w 90% \
  -h 90% \
  -E "yazi"
bind C-t display-popup \
  -d "#{pane_current_path}" \
  -w 75% \
  -h 75% \
  -E "zsh"
bind C-c display-popup -E 'bash -i -c "read -p \"Session name: \" name; tmux new-session -d -s \$name && tmux switch-client -t \$name"'
bind C-n display-popup -E "tmux list-sessions | sed -E 's/:.*$//' | grep -v \"^$(tmux display-message -p '#S')\$\" | fzf --reverse | xargs tmux switch-client -t"

# ------------------------------
# Status bar
# ------------------------------

set -g status-position bottom
set -g status-interval 5

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'dracula/tmux'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'christoomey/vim-tmux-navigator'

# Dracula Plugins
set -g @dracula-plugins "attached-clients ssh-session"
set -g @dracula-transparent-powerline-bg true
set -g @dracula-show-flags true
set -g @dracula-show-empty-plugins false
set -g @dracula-refresh-rate 5
set -g @dracula-show-powerline true
set -g @dracula-show-left-icon "#S"
set -g @dracula-show-edge-icons false
set -g @dracula-left-icon-padding 0

# Dracula SSH Session
set -g @dracula-ssh-session-colors "orange dark_gray"
set -g @dracula-show-ssh-only-when-connected false

# Dracula Attached Clients Plugin
set -g @dracula-clients-minimum 1
set -g @dracula-clients-singular client
set -g @dracula-clients-plural clients

# Dracula git Plugin
set -g @dracula-git-colors "light_purple dark_gray"
set -g @dracula-git-disable-status true
set -g @dracula-git-no-untracked-files true
set -g @dracula-git-show-remote-status true
set -g @dracula-git-show-repo-name true

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
